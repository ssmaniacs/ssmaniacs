<!DOCTYPE html>
<!--
Secret Societyで任意のアカウントからアカウントへギフトを送る
//-->
<html>
  <head>
    <title>Secret Society Secret Santa</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style type="text/css">
      /* 全角文字のAAが等幅でうまく表示されない環境があるのでNotoを埋め込む*/
      @font-face {
        font-family: 'Noto Sans Mono CJK JP';
        src: url('./NotoSansMonoCJKjp-Regular.woff2') format('woff2'),
          url('./NotoSansMonoCJKjp-Regular.woff') format('woff'),
          url('./NotoSansMonoCJKjp-Regular.otf') format('opentype');
      }
      pre {
        font-size: 12px;
        font-family: Osaka-mono, 'Osaka-等幅', 'ＭＳ ゴシック', 'Noto Sans Mono CJK JP',
          Consolas, Menlo, 'Liberation Mono', Courier, monospace;
      }
    </style>
  </head>
  <body>
    <h1>シークレットサンタ</h1>
    <p>送り主アカウントから受け取りアカウントへ、ウィッシュリストのアイテムを<strong>何回でも</strong>送れるよ。
    <blockquote style="background-color:#F8E0E0;padding:15px 15px 15px 15px;border:1px solid #F5A9A9;">
    2017年10月のアップデート（ハロウィンイベント）から、端末とSSサーバ間の通信方法が変更されました<br>
    2017年10月16日時点では従来の通信方法も利用できていますが、近い将来（アップデートが行き渡ったぐらい？）
    従来の通信方法が使用できなくなることが予想されます。<br>
    従来方式の通信ができなくなった時点でシークレットサンタは利用できなくなりますので、
    あらかじめご了承ください。<div align="center">m(_ _)m</div></blockquote>
    <!--
    送り主のアカウントUID設定、アカウント情報表示
    //-->
    <p><label>送り主アカウントUID：<input id="gifter_uid" type="text" name="gifter_uid"></label>
    <input type="button" value="アカウント情報確認" onClick="verify_gifter(document.getElementById('gifter_uid').value);">
    <table border=1 cellpadding="5">
      <tr>
        <th>確認状況</th>
        <th>名前</th>
        <th>職業</th>
        <th>レベル</th>
        <th>経験値</th>
        <th>友達の数</th>
      </tr>
      <tr>
        <td><span id="gifter_status">未確認</span></td>
        <td><span id="gifter_name"</br></span></td>
        <td><span id="gifter_job"></br></span></td>
        <td align="right"><span id="gifter_level"></br></span></td>
        <td align="right"><span id="gifter_exp"></br></span></td>
        <td align="right"><span id="gifter_friends"></br></span></td>
      </tr>
    </table>
    ※サーバの状態によっては通信にかなり時間がかかることがあります。気長にお待ちください。
    <div id="gifter_exp_hidden">
      <p><a href="#" title="説明を読む" onClick="fold('gifter_exp_'); return false;">説明を読む</a>
    </div>
    <div id="gifter_exp_shown" style="display: none">
      <p><a href="#" title="説明をたたむ" onClick="fold('gifter_exp_'); return false;">説明をたたむ</a>
      <ul>
        <li>ギフト送信者用に作成したダミーのSecret Societyアカウント。</li>
        <li>本質的にはチートアカウントなので、運営にバレたら取り消されちゃうかもしれない。</li>
        <li>アカウントが抹消されてたりした場合は自分で新しいアカウントを作ってちょ。</li>
        <li>2017年4月現在、友達が300人とか400人を超えると表示されなくなることがあるらしいので、友達追加ができないようなら自分で新しいアカウントを作って。</li>
        <li>UIDさえわかれば誰でも送り主にできるよ。</li>
        <li>アカウントUIDはcookieに保存されるのでなるべくcookieを消さないでね。自分のブラウザでcookieを保存できるようにする設定は各自で調べてくれ。</li>
      </ul>
    </div>
    <hr>
    <!--
    受け取りアカウント情報
    //-->
    <p><label>受け取りアカウントUID：<input id="giftee_uid" type="text" name="giftee_uid"></label>
    <div id="giftee_exp_hidden">
      <p><a href="#" title="説明を読む" onClick="fold('giftee_exp_'); return false;">説明を読む</a>
    </div>
    <div id="giftee_exp_shown" style="display: none">
      <p><a href="#" title="説明をたたむ" onClick="fold('giftee_exp_'); return false;">説明をたたむ</a>
      <ul>
        <li>ギフトを受け取りたいユーザ（自分）のアカウントのUID。</li>
        <li>UIDは↓に自分の招待コードを入力して<span id="gifter_name2"></span>の友達になればわかるよ。
          アルファベットのIと数字の1とかアルファベットのOと数字の0とか打ち間違いに気をつけるんだぞ。</li>
        <li>ただし一度友達になったのにUIDを忘れちゃった場合、そのまま再登録はできないので一度友達登録を解除
          （自分の端末の友達一覧から<span id="gifter_name3"></span>を削除）してから改めて登録してくれ。</li>
        <li>自分のアカウントUIDはcookieに保存されるのでなるべくcookieを消さないでね。自分のブラウザでcookieを保存できるようにする設定は各自で調べてくれ。</li>
        <li>自分のアカウントUIDは念のためメモしておくといいと思うよ。φ(..)</li>
        <li><label>友達招待コード：<input id="invite_code" type="text" name="invite_code"></label>
          <input id="add_friend" type="button" value="友達申請" onClick="add_friend(document.getElementById('invite_code').value);">
          <br><span id="add_status"></span></li>
      </ul>
    </div>
    <p>
    <input id="giftee_conf" type="button" value="受け取りアカウント確認とウィッシュリスト取得"
      onClick="verify_giftee(document.getElementById('giftee_uid').value);" disabled>
    <table border=1 cellpadding="5">
      <tr>
        <th>確認状況</th>
        <th>名前</th>
        <th>職業</th>
        <th>レベル</th>
        <th>経験値</th>
      </tr>
      <tr>
        <td><span id="giftee_status">未確認</span></td>
        <td><span id="giftee_name"</br></span></td>
        <td><span id="giftee_job"></br></span></td>
        <td align="right"><span id="giftee_level"></br></span></td>
        <td align="right"><span id="giftee_exp"></br></span></td>
      </tr>
    </table>
    ※サーバの状態によっては通信にかなり時間がかかることがあります。気長にお待ちください。
    <p>
    <table border="1" cellpadding="5">
      <tr>
        <th>ウィッシュ1</th>
        <th>ウィッシュ2</th>
        <th>ウィッシュ3</th>
        <th>ウィッシュ4</th>
        <th>ウィッシュ5</th>
        <th>特殊ギフト</th>
      </tr>
      <tr>
        <td><span id="wishname1"><br></span></td>
        <td><span id="wishname2"><br></span></td>
        <td><span id="wishname3"><br></span></td>
        <td><span id="wishname4"><br></span></td>
        <td><span id="wishname5"><br></span></td>
        <td><select id="wishother" onChange="wish_change(this);">
          <option value="">（なし）</option>
          <option value="847">ホタル</option>
          <option value="2222">てんとう虫</option>
          <option value="1663">人参</option>
          <option value="2117">キュービッドの矢</option>
          <option value="2892">トークン</option>
          </select>
          <select id="wishcount">
          <option value="1">x1</option>
          <option value="5">x5</option>
          <option value="10">x10</option>
          </select></td>
      </tr>
    </table>
    <p>
    <input id="get_gifts" type="button" value="ギフトをもらう！" onClick="get_gifts();" disabled>
    <span id="gift_status"></span>

    <div id="gift_exp_hidden">
      <p><a href="#" title="説明を読む" onClick="fold('gift_exp_'); return false;">説明を読む</a>
    </div>
    <div id="gift_exp_shown" style="display: none">
      <p><a href="#" title="説明をたたむ" onClick="fold('gift_exp_'); return false;">説明をたたむ</a>
      <ul>
        <li>ウィッシュリストのアイテムが全部もらえるよ。</li>
        <li>一日に何回でももらえるよ。</li>
        <li>別のアイテムが欲しい場合は自分の端末でウィッシュリストを更新してから↑の「ウィッシュリスト取得」を押して。
          自分の端末での更新がサーバに反映されるまではちょっとタイムラグがあるかも。</li>
        <li>乱用しすぎて運営に怪しまれたりするとアカウント抹消とかされちゃう<strong>かも</strong>しれないので、ほどほどにね。</li>
      </ul>
    </div>
    <hr>

    <div id="iecookie_hidden">
      <p><a href="#" title="説明を読む" onClick="fold('iecookie_'); return false;">IE10,IE11でcookieを保存する方法</a>
    </div>
    <div id="iecookie_shown" style="display: none">
      <p><a href="#" title="説明をたたむ" onClick="fold('iecookie_'); return false;">IE10,IE11でcookieを保存する方法をたたむ</a>
      <ol>
        <li>右上の歯車ボタン→[セーフティ]→[閲覧の履歴の削除]</li>
        <li>「クッキーとWebサイトデータ」のチェックをはずす</li>
        <li>「キャンセル」をクリックする（「削除」でもいいけどクッキー以外の履歴が本当に削除されるよ）</li>
      </ol>
    </div>

    <div id="uidinfo_hidden">
      <p><a href="#" title="説明を読む" onClick="fold('uidinfo_'); return false;">UIDに関する説明を読む</a>
    </div>
    <div id="uidinfo_shown" style="display: none">
      <p><a href="#" title="説明をたたむ" onClick="fold('uidinfo_'); return false;">UIDに関する説明をたたむ</a>
      <p>UIDというのは一人ひとりのアカウントに割り当てられた内部IDのこと。
        友達リストに出てくる名前は好きなように変えられるけどUIDは絶対に変わらない。
        （同じ端末でアンインストール／再インストールしても同じUIDになるので、
        何か端末を識別する情報を使って割り当ててるっぽい）

      <h4>自分のアカウントのUIDを知る方法</h4>
      <ol>
        <li>Secret Society端末から sh.g5e.com (68.168.210.20) TCPポート 80 への HTTP 通信をキャプチャする。
        <li>Secret Societyから送られるデータの大部分は、以下の形式のデータで始まっている。
          "parameters":[ の後の "suid_数字" が自分のUID（改行されてる場合もある）。数字は人によって6～8桁ぐらい。
          （まれに"suid_..."の形式じゃないUIDの人がいる。古い人かな？）
          <pre>{"serviceName": "GameService", "methodName":"XXX(いろいろ)","parameters":["suid_12345678", ...</pre> </li>
      </ol>

      <h4>友達アカウントのUIDを知る方法</h4>
      <ol>
        <li>SecretSociety端末から sh.g5e.com (68.168.210.20) TCPポート 80 への HTTP 通信をキャプチャする。</li>
        <li>目的の友達にギフトを１個送ってみる。</li>
        <li>SecretSocietyから発信されたデータから、1行目に"methodName":"SendGift" が含まれているものを探す。
          <pre>
{"serviceName": "GameService", "methodName":"SendGift","parameters":[
    "suid_12345678",
    "suid_87654321",
    ...
          </pre>
        <li>"parameters":[ 以降の１個目の"suid_数字"が自分のUID、２個目の"suid_数字"が相手のUID（項目の間で改行されている場合もある）。
      </ol>
    </div>

    <div id="techinfo_hidden">
      <p><a href="#" title="説明を読む" onClick="fold('techinfo_'); return false;">仕組みについて興味のある物好きは読んでみよう</a>
    </div>
    <div id="techinfo_shown" style="display: none">
      <p><a href="#" title="説明をたたむ" onClick="fold('techinfo_'); return false;">仕組みについての説明をたたむ</a>
      <p>Secret Societyのギフトのやり取りは全てSecret Society サーバを通じて行なわれる。
        当然のことながら実際のモノがやり取りされるのではなく、「誰かから誰かへ何かが送られた」
        という情報のみがやり取りされるだけ。
      <p>本来のギフトのやり取りはこんな感じ：
      <!-- pre style="font-size: 12px; font-family: Osaka-mono, 'Osaka-等幅', 'ＭＳ ゴシック',
        'Noto Sans Mono CJK JP', Consolas, Menlo, 'Liberation Mono', Courier, monospace;" -->
      <pre>
+----------+                    +----------+
|送り主●●|●●だけど、俺の友達|Secret    |
|          |今どうなってる？    |  Society |
|          |==================＞|    サーバ|
|          |○○さん、▲▲さん、|          |
|          |   □□さん、...だよ|          |
|          |＜------------------|          |
|          |                    |          |
|          |●●だけど、▲▲さん|          |
|          |に××を送っといて  |          |
|          |==================＞|          |
|          |            おっけー|          |
|          |＜------------------|          |                    +----------+
|          |                    |          |    ▲▲だけど、俺に|受取人▲▲|
|          |                    |          |    ギフト届いてる？|          |
|          |                    |          |＜==================|          |
|          |                    |          |●●さんから××が  |          |
|          |                    |          |届いてるよ          |          |
|          |                    |          |------------------＞|          |
|          |                    |          |                    |          |
|          |                    |          |▲▲だけど、××受け|          |
|          |                    |          |取るからお礼しといて|          |
|          |                    |          |＜==================|          |
|          |                    |          |おっけー            |          |
|          |                    |          |------------------＞|          |
|          |●●だけど、俺に    |          |                    |          |
|          |ギフト届いてる？    |          |                    +----------+
|          |==================＞|          |
|          |  ▲▲さんからお礼が|          |
|          |          届いてるよ|          |
|          |＜------------------|          |
|          |                    |          |
|          |●●だけど、お礼を  |          |
|          |受け取るわ          |          |
|          |==================＞|          |
|          |            おっけー|          |
|          |＜------------------|          |
|          |                    |          |
+----------+                    +----------+
</pre>

      <p>サーバはギフトのやり取りを中継する際、誰ががどのアイテムを何個持っているとか、
        一日に何個ギフトを送ったかとかの細かいことはチェックしていない模様。
        また送り主からの「●●だけど」を、サーバが無条件に信頼してしまうところがミソ。
      <p>シークレットサンタを使うとこんな感じ：
      <!-- pre style="font-size: 12px; font-family: Osaka-mono, 'Osaka-等幅', 'ＭＳ ゴシック',
        'Noto Sans Mono CJK JP', Consolas, Menlo, 'Liberation Mono', Courier, monospace;" -->
      <pre>
+----------+                    +----------+
|シーク    |●●だけど、俺の友達|Secret    |
|  レット  |今どうなってる？    |  Society |
|    サンタ|==================＞|    サーバ|
|          |○○さん、▲▲さん、|          |
|          |   □□さん、...だよ|          |
|          |＜------------------|          |
|          |                    |          |
|          |●●だけど、▲▲さん|          |
|          |に××を送っといて  |          |
|          |==================＞|          |
|          |            おっけー|          |
|          |＜------------------|          |                    +----------+
|          |                    |          |    ▲▲だけど、俺に|受取人▲▲|
+----------+                    |          |    ギフト届いてる？|          |
                                |          |＜==================|          |
 ていうか、このしくみって       |          |●●さんから××が  |          |
 送り主と受取人がグルになった   |          |届いてるよ          |          |
 オレオレ詐欺そのものだよな…   |          |------------------＞|          |
                                |          |                    |          |
                                |          |▲▲だけど、××受け|          |
                                |          |取るからお礼しといて|          |
                                |          |＜==================|          |
                                |          |おっけー            |          |
+----------+                    |          |------------------＞|          |
|本物の●●|●●だけど、俺に    |          |                    |          |
|          |ギフト届いてる？    |          |                    +----------+
|          |==================＞|          |
|          |  ▲▲さんからお礼が|          |
|          |          届いてるよ|          |
|          |＜------------------|          |
|          |                    |          |
|          |●●だけど（何も    |          |
|          |送ってないけど）    |          |
|          |お礼を受け取るわ    |          |
|          |==================＞|          |
|          |            おっけー|          |
|          |＜------------------|          |
|          |                    |          |
+----------+                    +----------+
</pre>
    </div>

<script type="text/javascript">
<!--
/*
このスクリプトではSecret Societyのサーバにアクセスする必要があるが
最近のブラウザはJavaScriptで別サイトにアクセスするのにCORSという
仕組みではアクセス先のサーバと協調しなければできないようになっている。

http://www.hoge.com/script -> http://www.hoge.com/target
これはアクセス元とアクセス先のドメインが同じなのでOK。

http://www.hoge.com/script -> http://www.piyo.com/target
これはアクセス元とアクセス先のドメインが異なるので基本NG、
アクセス先（www.piyo.com）がCORS対応している場合のみOK。

Secret SocietyのサーバはCORS対応していないので普通にはアクセスできない。
ただしCORSはJavaScriptから別ドメインへのアクセスを制限するものなので、
リクエストを転送してくれるプロキシがあれば制限を回避することができる。
このスクリプトでは以下の２通りのプロキシを使っている：

1.現在のホスティングサイト000webhost.comはphpを使えるのでphpプロキシを経由。

  このスクリプト -> redirect.php -> http://sh.g5e.com/...

  ホスティングサイトが変わったら使えなくなるかも。
  このスクリプトをローカルで動かすときは利用できない。

2.cors-anywhereというオープンなCORSプロキシを運用してくれている人がいるので、
  ありがたく使わせてもらう。

  このスクリプト -> cors-anywhere -> http://sh.g5e.com/...

  当然のことながらcors-anywhereがなくなっちゃったら使えなくなる。
  スクリプトをローカルで動かすときでも利用できる。
  ブラウザによってはうまく動かないことがある（Windows版Vivaldiなど）

上記 redirect.php の中身は以下のコード。
このスクリプトからのリクエストを本来のあて先にリダイレクトするだけ。

<?php
$url = $_SERVER["QUERY_STRING"];
$header = array(
  "User-Agent: " . $_SERVER["HTTP_USER_AGENT"],
  "Content-Type: " . $_SERVER["CONTENT_TYPE"]
);

$curl = curl_init();
curl_setopt($curl, CURLOPT_URL, $url);
curl_setopt($curl, CURLOPT_HTTPHEADER, $header);
curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);

if ($_SERVER["REQUEST_METHOD"] == "POST") {
  $data = file_get_contents("php://input");
  curl_setopt($curl, CURLOPT_POST, 1);
  curl_setopt($curl, CURLOPT_POSTFIELDS, $data);
}

$response = curl_exec($curl);
curl_close($curl);

echo $response;
?>

*/

var redirect_method = 0;
var redirect_php = "./redirect.php?";
var cors_anywhere = "http://cors-anywhere.herokuapp.com/";

/* Secret SocietyサーバのURL */
var g5e_url = "http://sh.g5e.com/hog_ios/jsonway_android.php";
var url = g5e_url;

/* その他、いろいろ表示・制御用 */
var gifter_uid;
var gifter_name;
var gifter_job;
var gifter_level;
var gifter_exp;
var gifter_friends;
var gifter_status;

var giftee_uid;
var giftee_name;
var giftee_job;
var giftee_level;
var giftee_exp;
var giftee_status;

var wishitem = new Array(6);
var wishname = new Array(6);

window.onload = function ()
{
  var result = new Array();
  var allcookies = document.cookie;
  if (allcookies != '') {
     var cookies = allcookies.split('; ');

     for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].split('=');
        result[cookie[0]] = decodeURIComponent(cookie[1]);
     }
  }

  gifter_uid = result['gifter_uid'];
  giftee_uid = result['giftee_uid'];

  if (!gifter_uid) {
    gifter_uid = "suid_34549937"; // ダミー "SecretSanta"
  };

  document.getElementById('gifter_uid').value = gifter_uid;

  if (giftee_uid) {
    document.getElementById('giftee_uid').value = giftee_uid;
  }

  verify_gifter(gifter_uid);
}


/*
  折りたたみ
*/
function fold(id)
{
  if (document.getElementById(id + "hidden").style.display == "none" ) {
    document.getElementById(id + "hidden").style.display = "block";
    document.getElementById(id + "shown").style.display = "none";
  }
  else {
    document.getElementById(id + "hidden").style.display = "none";
    document.getElementById(id + "shown").style.display = "block";
  }
}

/*
  送り主情報を初期化
*/
function reset_gifter()
{
  gifter_uid = null;
  gifter_name = "未確認";
  gifter_job = "未確認";
  gifter_level = "未確認";
  gifter_exp = "未確認";
  gifter_friends = "未確認";
  gifter_status = "未確認";
}

/*
  送り先情報を初期化
*/
function reset_giftee()
{
  giftee_uid = null;
  giftee_name = "未確認";
  giftee_job = "未確認";
  giftee_level = "未確認";
  giftee_exp = "未確認";
  giftee_status = "未確認";

  wishitem = [null, null, null, null, null, null];
  wishname = ["未確認", "未確認", "未確認", "未確認", "未確認", "未確認"];
}

function setcookie(name, val)
{
  // 無期限cookieを格納
  document.cookie = name + "=" + val + "; expires=Tue, 19 Jan 2038 03:14:07 GMT";
}

function refresh_gifter()
{
  document.getElementById('gifter_uid').value       = gifter_uid;
  document.getElementById('gifter_name').innerHTML  = gifter_name;
  document.getElementById('gifter_name2').innerHTML = gifter_name;
  document.getElementById('gifter_name3').innerHTML = gifter_name;
  document.getElementById('gifter_job').innerHTML   = gifter_job;
  document.getElementById('gifter_level').innerHTML = gifter_level;
  document.getElementById('gifter_exp').innerHTML   = gifter_exp;
  document.getElementById('gifter_friends').innerHTML   = gifter_friends;
  document.getElementById('gifter_status').innerHTML= gifter_status;
}

function refresh_giftee()
{
  document.getElementById('giftee_uid').value       = giftee_uid;
  document.getElementById('giftee_name').innerHTML  = giftee_name;
  document.getElementById('giftee_job').innerHTML   = giftee_job;
  document.getElementById('giftee_level').innerHTML = giftee_level;
  document.getElementById('giftee_exp').innerHTML   = giftee_exp;
  document.getElementById('giftee_status').innerHTML= giftee_status;

  for (var i = 1; i < wishname.length; i++) {
    document.getElementById('wishname' + i).innerHTML = wishname[i];
  }
  document.getElementById('wishother').value = ''

  document.getElementById('gift_status').innerHTML = ''
}

function get_jobname(job)
{
  if (job == 2) {
    return "商人";
  }
  else if (job == 4) {
    return "賢者";
  }
  else if (job == 8) {
    return "密偵";
  }
  else if (job == 16) {
    return "魔術師";
  }
  else {
    return "不明(" + job + ")";
  }
}

function verify_gifter(uid)
{
  reset_gifter();
  gifter_uid = uid;
  refresh_gifter();

  setcookie('gifter_uid', gifter_uid);

  document.getElementById('add_friend').disabled = true;
  document.getElementById('giftee_conf').disabled = true;
  document.getElementById('get_gifts').disabled = true;

  if (! uid) {
      return;
  }

  var data = '{"serviceName": "GameService", "methodName":"GetProfiles", "parameters":[[ "' + uid + '" ], null, 46]}'
  var request = new XMLHttpRequest();

  gifter_status = "<font color='green'>確認中...</font>";
  document.getElementById('gifter_status').innerHTML = gifter_status;

  var running = false;

  request.open('POST', url);
  request.onreadystatechange = function () {
    running = true;
    if (request.readyState != 4) {
        gifter_status = "<font color='green'>通信中...</font>";
        document.getElementById('gifter_status').innerHTML = gifter_status;
    }
    else if (request.status != 200) {
        if (redirect_method == 0) {       // 直接接続失敗
          redirect_method = 1;            // redirect.phpで試す
          url = redirect_php + g5e_url;
          verify_gifter(uid);
        }
        else if (redirect_method == 1) {  // redirect.php失敗
          redirect_method = 2;            // CORS-Anywhereを試す
          url = cors_anywhere + g5e_url;
          verify_gifter(uid);
        }
        else {                            // 全部失敗
          gifter_status = "<font color='red'>通信エラー</font>";
          document.getElementById('gifter_status').innerHTML = gifter_status;
        }
    }
    else {
      resp = JSON.parse(request.responseText);

      if (resp['error']) {
        gifter_status = "<font color='red'>サーバエラー</font>";
        document.getElementById('gifter_status').innerHTML = gifter_status;
        return;
      }

      if (resp['response'] && resp['response'][0] && resp['response'][0]['data'] && resp['response'][0]['data']['Profile']) {
        prof = resp['response'][0]['data']['Profile'];

        gifter_name = prof['username'];
        gifter_level = prof['level'];
        gifter_exp = prof['experience'];
        gifter_job = get_jobname(prof['profession']);
        gifter_friends = prof['friendsCount'];
        gifter_status = "確認済み";
        refresh_gifter();

        document.getElementById('add_friend').disabled = false;
        document.getElementById('giftee_conf').disabled = false;

        verify_giftee(giftee_uid);
      }
      else {
        gifter_status = "<font color='red'>確認エラー（アカウントが存在しないかも）</font>";
        document.getElementById('gifter_status').innerHTML = gifter_status;
      }
    }
  };
  request.setRequestHeader('Content-Type', 'application/json');
  request.send(data);
  setTimeout(
    function () {
      if (! running) {
        gifter_status = "<font color='red'>タイムアウト</font>";
        document.getElementById('gifter_status').innerHTML = gifter_status;
      }
    }, 60000
  );
}

function verify_giftee(uid)
{
  reset_giftee();
  if (uid) {
    giftee_uid = uid;
  }
  refresh_giftee();

  setcookie('giftee_uid', giftee_uid);

  document.getElementById('get_gifts').disabled = true;

  var data = {
    "serviceName": "GameService",
    "methodName": "GetFriends",
    "parameters": [
      gifter_uid,
      [
        "Profile.profession",
        "Profile.level",
        "Profile.experience",
        "Profile.username",
        "Wishes"
      ],
      5000,
      0,
      46
    ]
  }
  var request = new XMLHttpRequest();

  if (uid) {
    giftee_status = "<font color='green'>確認中...</font>";
    document.getElementById('giftee_status').innerHTML = giftee_status;
  }
  else {
    gifter_friends = "<font color='green'>確認中...</font>";
    document.getElementById('gifter_friends').innerHTML = gifter_friends;
  }

  var running = false;

  request.open('POST', url);
  request.onreadystatechange = function () {
    running = true;
    if (request.readyState != 4) {
      if (uid) {
        giftee_status = "<font color='green'>通信中...</font>";
        document.getElementById('giftee_status').innerHTML = giftee_status;
      }
      else {
        gifter_friends = "<font color='green'>通信中...</font>";
        document.getElementById('gifter_friends').innerHTML = gifter_friends;
      }
    }
    else if (request.status != 200) {
      if (uid) {
        giftee_status = "<font color='red'>通信エラー</font>";
        document.getElementById('giftee_status').innerHTML = giftee_status;
      }
      else {
        gifter_friends = "<font color='red'>通信エラー</font>";
        document.getElementById('gifter_friends').innerHTML = gifter_friends;
      }
    }
    else {
      resp = JSON.parse(request.responseText);

      if (resp['error']) {
        if (uid) {
          giftee_status = "<font color='red'>サーバエラー</font>";
          document.getElementById('giftee_status').innerHTML = giftee_status;
        }
        else {
          gifter_friends = "<font color='red'>サーバエラー</font>";
          document.getElementById('gifter_friends').innerHTML = gifter_friends;
        }
        return;
      }

      gifter_friends = resp['response'].length;
      document.getElementById('gifter_friends').innerHTML = gifter_friends;

      if (!uid) {
        return;
      }

      var match = null;

      if (resp['response']) {
        for(var i = 0; i < resp['response'].length; i++) {
          if (resp['response'][i]['uid'] == giftee_uid) {
            match = resp['response'][i];
            break;
          }
        }
      }

      if (! match) {
        giftee_status = "<font color='red'>確認エラー（友達じゃないかも）</font>";
        document.getElementById('giftee_status').innerHTML = giftee_status;
        return;
      }

      var prof = match['data']['Profile'];
      giftee_name = prof['username'];
      giftee_level = prof['level'];
      giftee_exp = prof['experience'];
      giftee_job = get_jobname(prof['profession']);
      giftee_status = "確認済み";

      var i = 0;
      if (match['data'] && match['data']['Wishes'] && match['data']['Wishes']['item_id']) {
        for (i = 0; i < match['data']['Wishes']['item_id'].length; i++) {
          wishitem[i+1] = match['data']['Wishes']['item_id'][i];
          if (itemlist[wishitem[i+1]]) {
            wishname[i+1] = itemlist[wishitem[i+1]];
          }
          else {
            wishname[i+1] = 'Item ID:' + wishitem[i+1];
          }
        }
        if (wishitem[1] || wishitem[0]) {
          document.getElementById('get_gifts').disabled = false;
        }
      }
      i++;

      while (i < wishname.length) {
        wishname[i] = "（なし）";
        i++;
      }


      refresh_giftee();
    }
  };
  request.setRequestHeader('Content-Type', 'application/json');
  request.send(JSON.stringify(data));
  setTimeout(
    function () {
      if (! running) {
        gifter_status = "<font color='red'>タイムアウト</font>";
        document.getElementById('gifter_status').innerHTML = gifter_status;
      }
    }, 60000
  );
}

function accept_friend()
{
  document.getElementById('add_status').innerHTML = "";

  var data = {
    "serviceName": "GameService",
    "methodName": "AcceptInvite",
    "parameters": [ giftee_uid, gifter_uid ]
  };

  var request = new XMLHttpRequest();
  document.getElementById('add_status').innerHTML = "友達承認中...";

  var running = false;

  request.open('POST', url);
  request.onreadystatechange = function () {
    running = true;
    if (request.readyState != 4) {
      document.getElementById('add_status').innerHTML = "通信中...";
    }
    else if (request.status != 200) {
      document.getElementById('add_status').innerHTML = "<font color='red'>通信エラー</font>";
    }
    else {
      resp = JSON.parse(request.responseText);

      if (resp['error']) {
        document.getElementById('add_status').innerHTML = "<font color='red'>サーバエラー</font>";
        return;
      }

      if (resp['response'] != true) {
        document.getElementById('add_status').innerHTML = "友達承認エラー。自分の端末の待機中友達リストに" + gifter_name + "がいるはずなので承認してから、↓のアカウント確認を押してみて。";
        return;
      }

      document.getElementById('add_status').innerHTML = "友達承認したよ。自分の端末の友達リストに" + gifter_name + "がいるはずなので確認してみて。";
      verify_giftee(giftee_uid);
    }
  };
  request.setRequestHeader('Content-Type', 'application/json');
  request.send(JSON.stringify(data));
  setTimeout(
    function () {
      if (! running) {
        gifter_status = "<font color='red'>タイムアウト</font>";
        document.getElementById('gifter_status').innerHTML = gifter_status;
      }
    }, 60000
  );
}

function add_friend(code)
{
  if (! code) {
    return;
  };

  document.getElementById('add_status').innerHTML = "";

  var data = {
    "serviceName": "GameService",
    "methodName": "UseInviteCode",
    "parameters": [ gifter_uid, code, true, true ]
  };

  var request = new XMLHttpRequest();
  document.getElementById('add_status').innerHTML = "友達申請中...";

  var running = false;

  request.open('POST', url);
  request.onreadystatechange = function () {
    running = true;
    if (request.readyState != 4) {
      document.getElementById('add_status').innerHTML = "通信中...";
    }
    else if (request.status != 200) {
      document.getElementById('add_status').innerHTML = "<font color='red'>通信エラー</font>";
    }
    else {
      resp = JSON.parse(request.responseText);

      if (resp['error']) {
        document.getElementById('add_status').innerHTML = "<font color='red'>サーバエラー</font>";
        return;
      }

      if (resp['response']['result'] == 3) {
        document.getElementById('add_status').innerHTML = "<font color='red'>招待コードが間違ってるって。古いのかも？</font>";
        return;
      }
      else if (resp['response']['result'] == 4) {
        document.getElementById('add_status').innerHTML = "<font color='red'>招待コードが間違ってるって。英数字６文字だよ。</font>";
        return;
      }
      else if (resp['response']['result'] == 5) {
        if (giftee_uid) {
          accept_friend();
        }
        else {
          document.getElementById('add_status').innerHTML = "<font color='red'>友達申請済みか、もう友達かも。待機中のリストに" + gifter_name + "がいたら承認して。再登録するならいったん友達削除して。</font>";
        }
        return;
      }
      else if (resp['response']['result'] != 0) {
        document.getElementById('add_status').innerHTML = "<font color='red'>友達申請エラー (" + resp['response']['result'] + ")</font>";
        return;
      }

      giftee_uid = resp['response']['uid'];
      accept_friend();
    }
  };
  request.setRequestHeader('Content-Type', 'application/json');
  request.send(JSON.stringify(data));
  setTimeout(
    function () {
      if (! running) {
        gifter_status = "<font color='red'>タイムアウト</font>";
        document.getElementById('gifter_status').innerHTML = gifter_status;
      }
    }, 60000
  );
}

var gift_flag = false;
var gifts_sent = 0;
var gifts_full = 0;
var gifts_fail = 0;

function wish_change(obj)
{
  var idx = obj.selectedIndex;
  wishitem[0] = obj.options[idx].value;
  wishname[0] = obj.options[idx].text;

  document.getElementById('get_gifts').disabled = !(wishitem[0] || wishitem[1]);
}


function get_gifts()
{
  if (!(wishitem[0] || wishitem[1])) {
    document.getElementById('gift_status').innerHTML = "ウィッシュリストが空だよ。";
    return;
  }

  gift_flag = true;
  gifts_sent = 0;
  gifts_full = 0;
  gifts_fail = 0;

  var idx = 0;

  document.getElementById('gift_status').innerHTML = "発送準備中...";

  var timerid = setInterval(
    function() {
      console.log(new Date());
      if (!gift_flag) {
        return;
      }

      while (idx < 6 && !wishitem[idx]) {
        idx++;
      }

      if (idx == 6) {
        clearInterval(timerid);

        var status = gifts_sent + "個のギフトを送ったよ。";

        if (gifts_full) {
          status += gifts_full + "個は受け取ってもらえなかったよ。";
        }

        if (gifts_fail) {
          status += "<font color='red'>" + gifts_fail + "個は送れなかったよ。";
        }

        document.getElementById('gift_status').innerHTML = status;
      }
      else if (wishitem[idx]) {
        gift_flag = false;
        var wishcount = 1;
        if (idx == 0) {
          var obj = document.getElementById('wishcount');
          wishcount = obj.options[obj.selectedIndex].value;
        }
        send_gift(wishitem[idx], wishname[idx], wishcount);
        idx += 1;
      }
    },
    1000);
}


function send_gift(itemid, itemname, itemcount)
{
  var data = {
    "serviceName": "GameService",
    "methodName": "SendGift",
    "parameters": [
      gifter_uid,
      giftee_uid,
      {
        "colvo" : +itemcount,
        "item_id" : +itemid,
        "item_id_random" : 68,
        "picture_id" : 1,
        "username" : gifter_name
      },
      parseInt((new Date()).getTime() / 1000)
    ]
  };

  var request = new XMLHttpRequest();
  document.getElementById('gift_status').innerHTML = itemname + "発送中...";

  var running = false;
  request.open('POST', url);
  request.onreadystatechange = function () {
    running = true;
    if (request.readyState != 4) {
      document.getElementById('gift_status').innerHTML = itemname + "発送中...";
    }
    else if (request.status != 200) {
      document.getElementById('gift_status').innerHTML = itemname + ": <font color='red'>通信エラー</font>";
      gifts_fail += 1;
      gift_flag = true;
    }
    else {
      resp = JSON.parse(request.responseText);

      if (resp['error']) {
        document.getElementById('gift_status').innerHTML = itemname + ": <font color='red'>サーバエラー</font>";
        gifts_fail += 1;
      }
      else if (resp['response']) {
        document.getElementById('gift_status').innerHTML = itemname + "発送完了。";
        gifts_sent += 1;
      }
      else {
        document.getElementById('gift_status').innerHTML = itemname + "受け取り拒否。";
        gifts_full += 1;
      }

      gift_flag = true;
    }
  };
  request.setRequestHeader('Content-Type', 'application/json');
  request.send(JSON.stringify(data));
  setTimeout(
    function () {
      if (! running) {
        gifter_status = "<font color='red'>タイムアウト</font>";
        document.getElementById('gifter_status').innerHTML = gifter_status;
        gifts_fail += 1;
        gift_flag = true;
      }
    }, 60000
  );
}
</script>
<script src="./itemlist.js"></script>
  </body>
</html>
