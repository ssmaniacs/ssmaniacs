<!DOCTYPE html>
<html>

<head>
<title>Secret Society コレクション・遺物</title>
<meta charset='utf-8'>
<meta name='viewport' content='width=device-width,initial-scale=1'>
<style type="text/css">
td {
  text.align: left;
  vertical-align: middle;
}

td.item {
  width: 120px;
  text-align: center;
  vertical-align: top;
}

td.num {
  text-align: right;
}

#item_popup{
	padding: 20px;
	border: 2px solid gray;
  overflow: auto;
  text-align: center;
	background: white;

	z-index: 2;
  position: absolute;
  display: none;
}

#item_table{
  background: #ffdd88;
  margin: 0 auto;
}
/* スピナーフレーム */
.spinner_frame {
  width: 100%;
  border: 1px solid silver;
  text-align: center;
  vertical-align: middle;
  display: table-cell;
}

/* ローディングスピナー */
.spinner {
  border: 16px solid #f3f3f3; /* Light grey */
  border-top: 16px solid #3498db; /* Blue */
  border-radius: 50%;
  width: 100px;
  height: 100px;
  animation: spin 2s linear infinite;
  margin: 0 auto;     /* align = center */
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}


</style>
<script src="collections_idx.js"></script>
<script>
// ページ内クリックイベント
function click_page(event) {
  var target = event.target;

  while (target) {
    if (target.id == 'item_popup') {
      return;                 // ポップアップ内のクリック：なにもしない
    }
    else if (target.className == 'item') {
      show_iteminfo(target);  // アイテムセル内のクリック：ポップアップ表示
      return;
    }
    else if (target instanceof HTMLBodyElement) {
      break;
    }
    target = target.parentElement;
  }

  // その他の場所：ポップアップをクローズ
  hide_iteminfo();
}

// アイテム情報ポップアップを表示
function show_iteminfo(elem) {
  var popup = document.getElementById('item_popup')
  popup.style.display = 'block';

  var icon_cell = document.getElementById('item_icon');
  var id_cell = document.getElementById('item_id');
  var name_cell = document.getElementById('item_name');
  var desc_cell = document.getElementById('item_desc');
  var from_cell = document.getElementById('item_from');

  // remove old icon
  while (icon_cell.firstChild) {
    icon_cell.removeChild(icon_cell.firstChild);
  }

  var itemid = elem.id.split('-')[1]

  icon_cell.appendChild(elem.firstChild.cloneNode());
  name_cell.innerHTML = elem.lastChild.textContent;
  id_cell.innerHTML = itemid;
  desc_cell.innerHTML = item_list[itemid].desc;

  // 入手方法
  var howto = '';
  for (var idx in item_list[itemid].find) {
    var find = item_list[itemid].find[idx];
    howto += '<p>';
    if (typeof(find) == 'string') {
      howto += find;
    }
    else {
      if (find.quest) {
        howto += 'クエスト: ' + find.quest + '<br>';
      }

      if (find.scene) {
        howto += '写真: ' + find.scene + '<br>';
      }
      else if (find.puzzle) {
        howto += 'パズル: ' + find.puzzle + '<br>';
      }
      else {
        howto += '写真: どれでも<br>';
      }

      if (find.cond) {
        howto += '条件: ' + find.cond + '<br>';
      }
      if (find.prob) {
        howto += '確率: ' + find.prob + '<br>';
      }
    }
  }

  from_cell.innerHTML = howto;

  // 表示位置を調整
  var item_table = document.getElementById('item_table');
  popup.style.width = parseInt(item_table.offsetWidth + 40) + 'px'
//  popup.style.height = parseInt(item_table.offsetHeight + 40) + 'px'

  // デフォルト=クリック位置
  var x = event.x;
  var y = event.y + 10;

  var popup_w = popup.offsetWidth;
  var popup_h = popup.offsetHeight;

  var window_w = window.innerWidth;
  var window_h = window.innerHeight;

  if (x + popup_w > window_w) { // 右にはみ出す
    x = window_w - popup_w;
    if (x < 0) {
      x = 0;
    }
  }

  if (y + popup_h > window_h) { // 下にはみ出す
    y = y - popup_h - 20;
    if (y < 0) {
      y = 0;
    }
  }

  x += window.scrollX;
  y += window.scrollY;

  popup.style.left = x + 'px';
  popup.style.top = y + 'px';
}

// アイテム情報ポップアップを閉じる
function hide_iteminfo() {
  document.getElementById('item_popup').style.display = 'none';
}

// JSONファイルのロード
function loadJSON(path, callback) {
  var xobj;

  try {
    // IEではXMLHttpRequestがうまく動かない（ことがある）
    xobj = new ActiveXObject('MSXML2.XMLHTTP.6.0');
  }
  catch (e) {
    xobj = new XMLHttpRequest();
  }

  try {
    if ('overrideMimeType' in xobj) {
      xobj.overrideMimeType('application/json');
    }

    xobj.open('GET', path, true);

    xobj.onreadystatechange = function(){
      if (xobj.readyState == 4) {
        if (xobj.status == '200' || (location.protocol == 'file:' && xobj.status == '0')) {
          // ドキュメントは見当たらないが、ローカルファイルの場合成功時にstatus=0になることがある
          // とりあえずWin版ChromeとIEではstatus=0. FireFoxではローカルでも200.
          callback(xobj.responseText);
        }
        else {
          var message;

          if (xobj.status) {
            message = xobj.status; // + ' ' + HttpStatus(xobj.status);
          }

          console.log('XMLHttpRequests.status = ' + xobj.status + ' ' + message);
          callback(new Error(message));
        }
      }
    }

    xobj.send(null);
  }
  catch(e) {
    console.log(e);
    callback(e);
  }
}

// JSONから読み込んだコレクション情報
var coll_list = null;

// coll_listから抽出した個別アイテム情報
var item_list = null;

function init() {
  // 表示範囲選択リストに項目を設定
  var selector = document.getElementById('select_list');

  for (var coll in collections) {
    var option = document.createElement('option');
    option.setAttribute('value', collections[coll].id);
    option.innerHTML = collections[coll].title;
    selector.appendChild(option);
  }

  list_change();
}


// 表示範囲リストが選択された
function list_change() {
  if (coll_list) {
    delete coll_list;
    coll_list = null;
  }
  if (item_list) {
    delete item_list;
    item_list = null;
  }

  // スピナー表示
  document.getElementById('scene_spframe').style.display = 'table-cell';

  // インデックスおよびリストを削除
  var div = document.getElementById('list_index')

  while (div.firstChild) {
    div.removeChild(div.firstChild);
  }

  var div = document.getElementById('item_list')

  while (div.firstChild) {
    div.removeChild(div.firstChild);
  }

  // 指定JSONをロード
  path = document.getElementById('select_list').value + '.json';
  setTimeout(function(){ loadJSON(path, update_list); }, 100);
}

// JSONロード完了
function update_list(resp) {
  if (!resp || resp instanceof Error) {
    alert(resp ? resp.message : 'アイテム情報ロードエラー');
    return;
  }

  coll_list = JSON.parse(resp);
  item_list = [];

  // JSONにしたがってページを作成

  if (coll_list.length > 1) {    // ページ内インデックスを作成
    var index = '<ul>';

    for (var idx in coll_list) {
      index += '<li><a href="#' + coll_list[idx].id + '">' + coll_list[idx].title + '</li>';
    }

    index += '</ul><hr>';

    document.getElementById('list_index').innerHTML = index;
  }

  // アイテムテーブルを作成
  var tables = '';

  for (var idx in coll_list) {
    var page = coll_list[idx];

    if (coll_list.length > 1) {  // ページ内アンカーを作成
      tables += '<h2><a name="' + page.id + '">' + page.title + '</a></h2>';
    }

    // テーブルヘッダを作成
    tables += '各アイテムのセルをクリック／タップするとアイテムの詳細が表示されます。';
    tables += '<table border="1" bgcolor="#ffdd88" cellpadding="5"><tr>';

    ['No.', 'コレクション名', 'アイテム1', 'アイテム2', 'アイテム3', 'アイテム4', 'アイテム5',
    'コレクション', 'エレメント', '報酬', 'ギフト'].forEach(function(i){
      tables += '<th>' + i + '</th>';
    });

    tables += '</tr>';

    // コレクション行を作成
    for (var coll_idx in page.colls) {
      var coll = page.colls[coll_idx];

      tables += '<tr>';
      tables += '<td class="id">' + coll.id + '</td>';
      tables += '<td>' + coll.name + '</td>';

      var gift = true;

      for (var item_idx in coll.items) {
        var item = coll.items[item_idx];

        tables += '<td class="item" id="item-' + item.id + '">';
        if (item.data) {
          tables += '<img src="' + item.data + '"><br>';
        }
        tables += item.name + '</td>';

        if (!item.gift) {
          gift = false;
        }

        item_list[item.id] = item;
      }

      tables += '<td>';
      for (var charge_idx in coll.charges) {
        var charge = coll.charges[charge_idx];
        tables += charge.name + ' x' + charge.count + '<br>';
      }
      tables += '</td>';

      tables += '<td>';
      for (var reward_idx in coll.rewards) {
        var reward = coll.rewards[reward_idx];
        tables += reward.name + ' x' + reward.count + '<br>';
      }
      tables += '</td>';

      if (gift) {
        tables += '<td>OK</td>';
      }
      else {
        tables += '<td bgcolor=#dd4444>NG</td>';
      }

      tables += '</tr>';
    }

    tables += '</table>';
    tables += '<div align="right"><a href="#">[TOP]</a></div>';
  }

  document.getElementById('item_list').innerHTML = tables;
  document.getElementById('scene_spframe').style.display = 'none';
}

</script>
</head>


<body onload="init();" onclick="click_page(event);">
<!-- navigating links -->
<a href="index.html">[HOME]</a><hr>
<h1>コレクション・遺物</h1>

<!-- アイテム詳細ポップアップ -->
<div id="item_popup">
  <table id="item_table" cellpadding="5" border="1" style="max-width: 450px;">
    <tr><td colspan="2" class="item" id="item_icon"></tr>
    <tr><th>名前</th><td id="item_name" align="left"></td></tr>
    <tr><th>ID</th><td id="item_id" align="left"></td></tr>
    <tr><th>説明</th><td id="item_desc" align="left"></td></tr>
    <tr><th>入手方法</th><td id="item_from" align="left"></td></tr>
  </table>
  <p><input type="button" value="閉じる" onclick="hide_iteminfo();"></p>
</div>

<!-- リストセレクタ -->
<select id="select_list" onchange="list_change();"></select>

<div id="scene_spframe" class="spinner_frame">
  <div id="scene_spinner" class="spinner"></div>
</div>
<!-- アイテム一覧テーブル領域 -->
<p id="list_index"></p>
<div id="item_list"></div>
<hr>
<a href="index.html">[HOME]</a>
</body>
</html>
