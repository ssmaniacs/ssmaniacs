<!DOCTYPE html>
<html lang="ja">
  <head>
    <title>Secret Society Secret Santa</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style type="text/css">
      /* 全角文字のAAが等幅でうまく表示されない環境があるのでNotoを埋め込む*/
      @font-face {
        font-family: 'Noto Sans Mono CJK JP';
        src: url('./NotoSansMonoCJKjp-Regular.woff2') format('woff2'),
          url('./NotoSansMonoCJKjp-Regular.woff') format('woff'),
          url('./NotoSansMonoCJKjp-Regular.otf') format('opentype');
      }
      pre {
        font-size: 12px;
        font-family: Osaka-mono, 'Osaka-等幅', 'ＭＳ ゴシック', 'Noto Sans Mono CJK JP',
          Consolas, Menlo, 'Liberation Mono', Courier, monospace;
      }
    </style>
  </head>
  <body>
    <h1>シークレットサンタ</h1>
    <p>ウィッシュリストのアイテムを SecretSanta <img src='img/pic_12.jpg' width=50 height=50> から（一日に何回でも）もらえます。
    <blockquote style="background-color:#F8E0E0;padding:15px 15px 15px 15px;border:1px solid #F5A9A9;">
    2017年10月のアップデート（ハロウィンイベント）から、端末とSSサーバ間の通信方法が変更されました<br>
    2017年10月16日時点では従来の通信方法も利用できていますが、近い将来（アップデートが行き渡ったぐらい？）
    従来の通信方法が使用できなくなることが予想されます。<br>
    従来方式の通信ができなくなった時点でシークレットサンタは利用できなくなる可能性がありますので、
    あらかじめご了承ください。<div align="center">m(_ _)m</div></blockquote>
    <blockquote style="background-color:#e1f6dd;padding:15px 15px 15px 15px;border:1px solid #629666;">
    旧シークレットサンタユーザの皆様：送り主と送り先が友達同士である必要がないことがわかったため、
    サイトの構成を大幅に簡略化しました。本サイトは従来どおり引き続きご利用いただけます。
    また自分の友達リストに登録されているSecretSantaを削除しても、このサイトの動作には変わりありません。
    </blockquote>
    <!--
    受け取りアカウント情報
    //-->
    <p>SSユーザID: <input id="userinput" type="text">
      <input type="button" value="ユーザID・ウィッシュリスト確認" onClick="verify_user()">
    <table border=1 cellpadding="5">
      <tr>
        <th>ユーザID</th>
        <th>アバター</th>
        <th>名前</th>
        <th>職業</th>
        <th>レベル</th>
      </tr>
      <tr>
        <td align="center"><span id="userid"><br></span></td>
        <td align="center"><span id="avatar"><br></span></td>
        <td align="center"><span id="username"><br></span></td>
        <td align="center"><span id="profession"><br></span></td>
        <td align="center"><span id="level"><br></span></td>
      </tr>
    </table>
    <p>ユーザIDとはSSゲーム内部で使用されるIDのことで、自分で決めたユーザ名とは異なります。<br>
      自分のユーザIDを知らない場合（普通は知りません）、代わりに招待コードを入力してください。<br>
      入力または招待コードを元に取得されたユーザIDはブラウザのクッキーに保存されます。<br>
      招待コードを入力する場合、自分の端末の友達リストまたは待機中リストに&quot;SecretSanta&quot;
      がいたら事前に削除しておいてください。
      友達申請済みあるいは既に友達となっているユーザの招待コードは受け付けられません。

    <p>
    <table border="1" cellpadding="5">
      <tr>
        <th>ウィッシュ1</th>
        <th>ウィッシュ2</th>
        <th>ウィッシュ3</th>
        <th>ウィッシュ4</th>
        <th>ウィッシュ5</th>
        <th>特殊ギフト</th>
      </tr>
      <tr>
        <td><span id="wishname1"><br></span></td>
        <td><span id="wishname2"><br></span></td>
        <td><span id="wishname3"><br></span></td>
        <td><span id="wishname4"><br></span></td>
        <td><span id="wishname5"><br></span></td>
        <td><select id="wishother" onChange="wish_change(this);">
          <option value="">（なし）</option>
          <option value="847">ホタル</option>
          <option value="2222">てんとう虫</option>
          <option value="1663">人参</option>
          <option value="2117">キュービッドの矢</option>
          <option value="2892">トークン</option>
          </select>
          <select id="wishcount">
          <option value="1">x1</option>
          <option value="5">x5</option>
          <option value="10">x10</option>
          </select></td>
      </tr>
    </table>
    <p>
    <input type="button" value="ギフトをもらう！" onClick="send_gifts();">
    <span id="gift_status"></span>

    <p>ウィッシュリストのアイテム（＋特殊ギフト）を全部、一日に何回でも発送できます。<br>
    別のアイテムが欲しい場合は自分の端末でウィッシュリストを更新してから↑の「ウィッシュリスト確認」を押す。<br>
    自分の端末での更新がサーバに反映されるまではちょっとタイムラグがあるかも。<br>
    乱用しすぎて運営に怪しまれたりするとアカウント抹消とかされちゃう<strong>かも</strong>しれないので、利用はほどほどに。
    <hr>

    <div id="iecookie_hidden">
      <p><a href="#" title="説明を読む" onClick="fold('iecookie_'); return false;">IE10,IE11でcookieを保存する方法</a>
    </div>
    <div id="iecookie_shown" style="display: none">
      <p><a href="#" title="説明をたたむ" onClick="fold('iecookie_'); return false;">IE10,IE11でcookieを保存する方法をたたむ</a>
      <ol>
        <li>右上の歯車ボタン→[セーフティ]→[閲覧の履歴の削除]</li>
        <li>「クッキーとWebサイトデータ」のチェックをはずす</li>
        <li>「キャンセル」をクリックする（「削除」でもいいけどクッキー以外の履歴が本当に削除されるよ）</li>
      </ol>
    </div>

    <div id="uidinfo_hidden">
      <p><a href="#" title="説明を読む" onClick="fold('uidinfo_'); return false;">UIDに関する説明を読む</a>
    </div>
    <div id="uidinfo_shown" style="display: none">
      <p><a href="#" title="説明をたたむ" onClick="fold('uidinfo_'); return false;">UIDに関する説明をたたむ</a>
      <p>UIDというのは一人ひとりのアカウントに割り当てられた内部IDのこと。
        友達リストに出てくる名前は好きなように変えられるけどUIDは絶対に変わらない。
        （同じ端末でアンインストール／再インストールしても同じUIDになるので、
        何か端末を識別する情報を使って割り当ててるっぽい）

      <p><font color="red">2017年10月のアップデート以降、端末とSSサーバ間の通信はSSLで暗号化されるようになったため、
        以下に示す単純なキャプチャによる方法では通信内容を読み取ることができなくなりました。</font>

      <h4>自分のアカウントのUIDを知る方法</h4>
      <ol>
        <li>Secret Society端末から sh.g5e.com (68.168.210.20) TCPポート 80 への HTTP 通信をキャプチャする。
        <li>Secret Societyから送られるデータの大部分は、以下の形式のデータで始まっている。
          "parameters":[ の後の "suid_数字" が自分のUID（改行されてる場合もある）。数字は人によって6～8桁ぐらい。
          （まれに"suid_..."の形式じゃないUIDの人がいる。古い人かな？）
          <pre>{"serviceName": "GameService", "methodName":"XXX(いろいろ)","parameters":["suid_12345678", ...</pre> </li>
      </ol>

      <h4>友達アカウントのUIDを知る方法</h4>
      <ol>
        <li>SecretSociety端末から sh.g5e.com (68.168.210.20) TCPポート 80 への HTTP 通信をキャプチャする。</li>
        <li>目的の友達にギフトを１個送ってみる。</li>
        <li>SecretSocietyから発信されたデータから、1行目に"methodName":"SendGift" が含まれているものを探す。
          <pre>
{"serviceName": "GameService", "methodName":"SendGift","parameters":[
    "suid_12345678",
    "suid_87654321",
    ...
          </pre>
        <li>"parameters":[ 以降の１個目の"suid_数字"が自分のUID、２個目の"suid_数字"が相手のUID（項目の間で改行されている場合もある）。
      </ol>
    </div>

    <div id="techinfo_hidden">
      <p><a href="#" title="説明を読む" onClick="fold('techinfo_'); return false;">仕組みについて興味のある物好きは読んでみよう</a>
    </div>
    <div id="techinfo_shown" style="display: none">
      <p><a href="#" title="説明をたたむ" onClick="fold('techinfo_'); return false;">仕組みについての説明をたたむ</a>
      <p>Secret Societyのギフトのやり取りは全てSecret Society サーバを通じて行なわれる。
        当然のことながら実際のモノがやり取りされるのではなく、「誰かから誰かへ何かが送られた」
        という情報のみがやり取りされるだけ。
      <p>本来のギフトのやり取りはこんな感じ：
      <!-- pre style="font-size: 12px; font-family: Osaka-mono, 'Osaka-等幅', 'ＭＳ ゴシック',
        'Noto Sans Mono CJK JP', Consolas, Menlo, 'Liberation Mono', Courier, monospace;" -->
      <pre>
+----------+                    +----------+
|送り主●●|●●だけど、俺の友達|Secret    |
|          |今どうなってる？    |  Society |
|          |==================＞|    サーバ|
|          |○○さん、▲▲さん、|          |
|          |   □□さん、...だよ|          |
|          |＜------------------|          |
|          |                    |          |
|          |●●だけど、▲▲さん|          |
|          |に××を送っといて  |          |
|          |==================＞|          |
|          |            おっけー|          |
|          |＜------------------|          |                    +----------+
|          |                    |          |    ▲▲だけど、俺に|受取人▲▲|
|          |                    |          |    ギフト届いてる？|          |
|          |                    |          |＜==================|          |
|          |                    |          |●●さんから××が  |          |
|          |                    |          |届いてるよ          |          |
|          |                    |          |------------------＞|          |
|          |                    |          |                    |          |
|          |                    |          |▲▲だけど、××受け|          |
|          |                    |          |取るからお礼しといて|          |
|          |                    |          |＜==================|          |
|          |                    |          |おっけー            |          |
|          |                    |          |------------------＞|          |
|          |●●だけど、俺に    |          |                    |          |
|          |ギフト届いてる？    |          |                    +----------+
|          |==================＞|          |
|          |  ▲▲さんからお礼が|          |
|          |          届いてるよ|          |
|          |＜------------------|          |
|          |                    |          |
|          |●●だけど、お礼を  |          |
|          |受け取るわ          |          |
|          |==================＞|          |
|          |            おっけー|          |
|          |＜------------------|          |
|          |                    |          |
+----------+                    +----------+
</pre>

      <p>サーバはギフトのやり取りを中継する際、誰ががどのアイテムを何個持っているとか、
        一日に何個ギフトを送ったかとかの細かいことはチェックしていない模様。
        また送り主からの「●●だけど」を、サーバが無条件に信頼してしまうところがミソ。
        送り主と送り先が友達である必要もなく、そもそも送り主アカウントが存在していなくてもよい。
      <p>シークレットサンタを使うとこんな感じ：
      <!-- pre style="font-size: 12px; font-family: Osaka-mono, 'Osaka-等幅', 'ＭＳ ゴシック',
        'Noto Sans Mono CJK JP', Consolas, Menlo, 'Liberation Mono', Courier, monospace;" -->
      <pre>
+----------+                    +----------+
|シーク    |●●だけど、▲▲さん|Secret    |
|  レット  |に××を送っといて  |  Society |
|    サンタ|==================＞|    サーバ|
|          |            おっけー|          |                    +----------+
|          |＜------------------|          |    ▲▲だけど、俺に|受取人▲▲|
|          |                    |          |    ギフト届いてる？|          |
+----------+                    |          |＜==================|          |
 ※ユーザ●●は存在しない!!     |          |●●さんから××が  |          |
                                |          |届いてるよ          |          |
 ていうか、このしくみって       |          |------------------＞|          |
 送り主と受取人がグルになった   |          |                    |          |
 オレオレ詐欺そのものだよな…   |          |▲▲だけど、××受け|          |
                                |          |取るからお礼しといて|          |
                                |          |＜==================|          |
                                |          |●●さんって知らない|          |
                                |          |からお礼は無理ー    |          |
                                |          |------------------＞|          |
                                |          |                    |          |
                                +----------+                    +----------+
</pre>
    </div>

<script src='./PostRequest.js'></script>
<script src="./itemlist.js"></script>
<script type="text/javascript">
<!--
/*
このスクリプトではSecret Societyのサーバにアクセスする必要があるが
最近のブラウザはJavaScriptで別サイトにアクセスするのにCORSという
仕組みではアクセス先のサーバと協調しなければできないようになっている。

http://www.hoge.com/script -> http://www.hoge.com/target
これはアクセス元とアクセス先のドメインが同じなのでOK。

http://www.hoge.com/script -> http://www.piyo.com/target
これはアクセス元とアクセス先のドメインが異なるので基本NG、
アクセス先（www.piyo.com）がCORS対応している場合のみOK。

Secret SocietyのサーバはCORS対応していないので普通にはアクセスできない。
ただしCORSはJavaScriptから別ドメインへのアクセスを制限するものなので、
リクエストを転送してくれるプロキシがあれば制限を回避することができる。
このスクリプトでは以下の２通りのプロキシを使っている：

1.現在のホスティングサイト000webhost.comはphpを使えるのでphpプロキシを経由。

  このスクリプト -> redirect.php -> http://sh.g5e.com/...

  ホスティングサイトが変わったら使えなくなるかも。
  このスクリプトをローカルで動かすときは利用できない。

2.cors-anywhereというオープンなCORSプロキシを運用してくれている人がいるので、
  ありがたく使わせてもらう。

  このスクリプト -> cors-anywhere -> http://sh.g5e.com/...

  当然のことながらcors-anywhereがなくなっちゃったら使えなくなる。
  スクリプトをローカルで動かすときでも利用できる。
  ブラウザによってはうまく動かないことがある（Windows版Vivaldiなど）

上記 redirect.php の中身は以下のコード。
このスクリプトからのリクエストを本来のあて先にリダイレクトするだけ。

<?php
$url = $_SERVER["QUERY_STRING"];
$header = array(
  "User-Agent: " . $_SERVER["HTTP_USER_AGENT"],
  "Content-Type: " . $_SERVER["CONTENT_TYPE"]
);

$curl = curl_init();
curl_setopt($curl, CURLOPT_URL, $url);
curl_setopt($curl, CURLOPT_HTTPHEADER, $header);
curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);

if ($_SERVER["REQUEST_METHOD"] == "POST") {
  $data = file_get_contents("php://input");
  curl_setopt($curl, CURLOPT_POST, 1);
  curl_setopt($curl, CURLOPT_POSTFIELDS, $data);
}

$response = curl_exec($curl);
curl_close($curl);

echo $response;
?>

*/

var dummy_uid = 'suid_30357589';  // 招待コード処理用休眠アカウント
var gifter_uid = 'suid_00000000';
var gifter_name = 'SecretSanta';
var gifter_pic = 12;

var userinfo = {};
var wishitem = new Array(6);
var wishname = new Array(6);

var message = {
  'Unknown': '不明',
  'need_uid': 'ユーザIDまたは招待コードを入力、確認してください',
  'code_error': '入力コード不正',
  'net_error': '通信エラー',
  'prepare': '準備中...',
  'request': '通信中...',
  'timeout': 'タイムアウト',
  'code_expired': '招待コード不正または無効。最新の招待コードを入力してください。',
  'code_format': '招待コード不正。英数字６文字で入力してください。',
  'code_waiting': '友達申請済み。解除してから再試行してください。',
  'code_invite': '友達申請エラー'
};

function setcookie(name, val)  // 無期限cookieを格納
{
  document.cookie = name + "=" + val + "; expires=Tue, 19 Jan 2038 03:14:07 GMT";
}


window.onload = function ()
{
  var result = new Array();
  var allcookies = document.cookie;
  if (allcookies != '') {
     var cookies = allcookies.split('; ');

     for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].split('=');
        result[cookie[0]] = decodeURIComponent(cookie[1]);
     }
  }

  if ('userid' in result) {
    document.getElementById('userinput').value = result['userid'];
    verify_user();
  }
  else if ('giftee_uid' in result) {
    // 旧名称のcookie -> cookieを更新
    document.getElementById('userinput').value = result['giftee_uid'];
    setcookie('userid', result['giftee_uid'])
    document.cookie = "giftee_uid=; max-age=0";
    verify_user();
  }
}


/*
  折りたたみ
*/
function fold(id)
{
  if (document.getElementById(id + "hidden").style.display == "none" ) {
    document.getElementById(id + "hidden").style.display = "block";
    document.getElementById(id + "shown").style.display = "none";
  }
  else {
    document.getElementById(id + "hidden").style.display = "none";
    document.getElementById(id + "shown").style.display = "block";
  }
}

function get_jobname(job)
{
  if (job == 2) {
    return "商人";
  }
  else if (job == 4) {
    return "賢者";
  }
  else if (job == 8) {
    return "密偵";
  }
  else if (job == 16) {
    return "魔術師";
  }
  else {
    return "不明 (" + job + ")";
  }
}


/*
  送り先情報を初期化
*/
function reset_userinfo()
{
  userinfo = {
    'userid': null,
    'avatar': null,
    'username': null,
    'profession': null,
    'level': null,
  };
  wishitem = [null, null, null, null, null, null];
  wishname = [null, null, null, null, null, null];
}


function display_userinfo()
{
  document.getElementById('userid'    ).innerHTML = userinfo['userid']     ? userinfo['userid']     : '';
  document.getElementById('avatar'    ).innerHTML = userinfo['avatar']     ? userinfo['avatar']     : '';
  document.getElementById('username'  ).innerHTML = userinfo['username']   ? userinfo['username']   : '';
  document.getElementById('profession').innerHTML = userinfo['profession'] ? userinfo['profession'] : '';
  document.getElementById('level'     ).innerHTML = userinfo['level']      ? userinfo['level']      : '';

  for (var i = 1; i < wishname.length; i++) {
    document.getElementById('wishname' + i).innerHTML = wishname[i] ? wishname[i] : '';
  }
  document.getElementById('wishother').value = ''

  document.getElementById('gift_status').innerHTML = ''
}


// ユーザID確認ボタンが押された
function verify_user()
{
  var code = document.getElementById('userinput').value;

  reset_userinfo();
  display_userinfo();

  if (code.length < 6) {
    document.getElementById('userid').value = '<font color="red">' + message['code_error'] + '</font>';
  }
  else if (code.length == 6) {  // assume invite code
    // 招待コードを入力して確認ボタンが押された
    // 招待コードを使用してユーザIDを取得する
    get_uid_from_invite(code, document.getElementById('userid'),
      function(uid) { verify_invite_done(uid); });   // use invite code and get uid
  }
  else {  // assume userid
    userinfo['userid'] = code;
    document.getElementById('userid').innerHTML = code;
    get_profile();
  }
}


function verify_invite_done(uid)
{
  userinfo['userid'] = uid;
  document.getElementById('userinput').value = uid;
  get_profile();
}

// UID取得・招待取り消し成功、またはUIDを入力して確認ボタンが押された
function get_profile()
{
  var req = {
    "serviceName": "GameService",
    "methodName": "GetProfiles",
    "parameters": [
      [userinfo['userid']], null, ss_client_version
    ]
  };

  document.getElementById('userid').innerHTML = userinfo['userid'];

  post_request(req, document.getElementById('avatar'),
    function(resp) { get_profile_done(resp); });
}

// GetProfilesリクエスト完了
function get_profile_done(resp)
{
  var status = document.getElementById('username')

  var profile = null;
  try {
    profile = resp[0]['data'];
  }
  catch (e) {}

  if (!profile) {
    status.innerHTML = '<font color="red">' + message['code_error'] + '</font>';
    return;
  }

  // 無期限cookieを格納
  document.cookie = "userid=" + userinfo['userid'] + "; expires=Tue, 19 Jan 2038 03:14:07 GMT";

  // プロファイル情報を取得
  userinfo['username']    = profile['Profile']['username'];
  userinfo['profession']  = get_jobname(profile['Profile']['profession']);
  userinfo['level']       = profile['Profile']['level'];

  var imgurl = 'img/pic_1.jpg';
  if (profile['FB_pic']) {
    imgurl = profile['FB_pic'];
  }
  else if (profile['Profile']['picture_id'] > 0) {
    imgurl = 'img/pic_' + profile['Profile']['picture_id'] + '.jpg';
  }

  userinfo['avatar'] = '<img src="' + imgurl + '" width=50 height=50>';

  // ウィッシュリスト情報を取得
  var i = 0;
  if (profile['Wishes'] && profile['Wishes']['item_id']) {
    for (i = 0; i < profile['Wishes']['item_id'].length; i++) {
      wishitem[i+1] = profile['Wishes']['item_id'][i];
      if (itemlist[wishitem[i+1]]) {
        wishname[i+1] = itemlist[wishitem[i+1]];
      }
      else {
        wishname[i+1] = 'Item ID:' + wishitem[i+1];
      }
    }
  }
  i++;

  while (i < wishname.length) {
    wishitem[i] = null;
    wishname[i] = "（なし）";
    i++;
  }

  // ユーザ情報を表示
  display_userinfo();
}


/*
  特殊ウィッシュアイテム変更
*/
function wish_change(obj)
{
  var idx = obj.selectedIndex;
  wishitem[0] = obj.options[idx].value;
  wishname[0] = obj.options[idx].text;
}

/*
  SendGiftsToAllを利用したウィッシュアイテム一括発送
*/
function send_gifts()
{
  if (!(wishitem[0] || wishitem[1])) {
    document.getElementById('gift_status').innerHTML = "ウィッシュリストが空だよ。";
    return;
  }

  document.getElementById('gift_status').innerHTML = "発送準備中...";

  var req = {
    "serviceName": "GameService",
    "methodName": "SendGiftsToAll",
    "parameters": [
      gifter_uid,
      [
        [
          userinfo['userid'],
          []
        ]
      ]
    ]
  };

  for (var idx = 0; idx < wishitem.length; idx++) {
    if (wishitem[idx]) {
      var colvo = 1;

      if (idx == 0) {
        var obj = document.getElementById('wishcount');
        colvo = obj.options[obj.selectedIndex].value;
      }

      var gift = {
        "colvo" : +colvo,
        "item_id" : +wishitem[idx],
        "picture_id" : gifter_pic,
        "username" : gifter_name
      };

      req['parameters'][1][0][1].push(gift);
    }
  }

  post_request(req, document.getElementById('gift_status'),
    function(resp) { send_gifts_done(resp); });
}

// ギフト発送完了
function send_gifts_done(resp)
{
  var gifts_sent = 0;
  var gifts_fail = 0;

  resp[0][1].forEach(function(result) {
    if (result) {
      gifts_sent += 1;
    }
    else {
      gifts_fail += 1;
    }
  });

  var msg = '';

  if (gifts_sent) {
    msg += gifts_sent + "件発送成功。";
  }
  if (gifts_fail) {
    msg += gifts_fail + "件発送失敗（ギフトボックスが一杯）。";
  }

  document.getElementById('gift_status').innerHTML = msg;
}
</script>
  </body>
</html>
